---
title: "Modeling code"
output: github_document
date: 2020-03-30
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Initial Parameters

I am arbitrarily choosing XX,XXX people for my simulation. I am also choosing a timeline similar to what we saw in NYC, with *ADD IN DATES AND INFORMATION*.
```{r}
initial_population_size = 20 # TODO - choose bigger number later
total_days = 100

# TODO - fill these in with real numbers
day_of_first_distancing_guideline = 10
day_of_stronger_distancing_directive = 15
length_of_distancing_directive = 90
```

These initial parameters come from my best efforts at parsing the literature, specificially ARTICLE A and ARTICLE B.
```{r}
## BIG TODO: add citations for these numbers

#probability_symptomatic = 2/3 # Take this out?
probability_asymptomatic = 1/3

# TODO: break this out into it's own code chunk with explanation? Weighted average, solved equations to get 
basic_reproductive_number = 2.4
symptomatic_reproductive_number = basic_reproductive_number*(6/5)
asymptomatic_reproductive_number = basic_reproductive_number*(3/5)

time_until_infectious = 4 # This is figured from the incubation period, and rounded down from 4.6 so I can do steps in full days.

# For the asymptomatic types
asymptomatic_time_from_infectious_to_recovery = 4 # This is figured from the generation time (confusing). Should this be longer??

# For the symptomatic types
time_infectious_before_symptom_onset = 1
time_from_symptom_onset_to_recovery = 4

time_until_seeking_care = 5 # This is the number of days after symptom onset that people seek hospital care if they need it, on average
time_in_hospital_bed = 10
time_until_death_if_no_care = 10

```

These numbers come from NYC open data.
```{r}
initial_hospital_bed_capacity = 100 #TODO - fill in with real number later
hospital_beds_available = initial_hospital_bed_capacity

# TODO - fill in distributions of: age, health status/underlying conditions, "essential" jobs, poverty levels, incarcerated, homeless, detained immigrants, insurance coverage 
```

These numbers come from ARTICLE A, describing the distribution by age of who needs hospital care, and what their mortality rate is.
```{r}
# TODO: fill in from article.
```

And finally, based on some other research and best guesses:
```{r}
# TODO: flesh out this section

probability_seek_care_insured = 1
probability_seek_care_uninsured = 0.5

# TODO: decide on cutoff poverty level for ignoring a stay-home directive
```


## States

The way I organized my thoughts for this project was to create a state diagram (essentially a flow chart) to lay out all of the different trajectories someone could take through this epidemic. Everyone starts as "succeptible", and from there you have different probabilities of transitioning to other states, dependent on factors like random chance, demographic characteristics, as well as actions taken by others (like infecting you).

*TODO: put in an image of my state diagram*

```{r}
SUCCEPTIBLE = "succeptible"

INFECTED_ASYMPTOMATIC = "infected_asymptomatic"
INFECTIOUS_ASYMPTOMATIC = "infectious_asymptomatic"

INFECTED_SYMPTOMATIC_PRE_SYMPTOMS = "infected_symptomatic_pre_symptoms"
INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS = "infectious_symptomatic_pre_symptoms"

SYMPTOMATIC_NEED_HOSPITAL = "symptomatic_need_hospital"
SYMPTOMATIC_DONT_NEED_HOSPITAL = "symptomatic_dont_need_hospital"

NEED_HOSPITAL_SEEK_CARE = "need_hospital_seek_care"
NEED_HOSPITAL_DONT_SEEK_CARE = "need_hospital_dont_seek_care"

GET_HOSPITAL_CARE = "get_hospital_care"
DONT_GET_NEEDED_CARE = "dont_get_needed_care"

RECOVERED = "recovered"
DEAD = "dead"
```

I used another state diagram to map out who is staying at home, and who is still out and about.

*TODO: put in an image of my 2nd state diagram*



## Change states on each timestep

Helper functions: 
```{r}
# Set up an empty table with columns for each day in the simulation.
# When someone is randomly selected to be infected, I put a 1 in the spot corresponding to that person (row) on that day (column).
# This is referenced by the change_state function, to transition people from SUCCEPTIBLE to INFECTED.
newly_infected = tibble(
  person_ids = 1:initial_population_size,
)

for (i in 1:total_days) {
  newly_infected =
    add_column(
      newly_infected,
      !!str_c("day_", i) := 0
      )
}

# This function gets called a variable number of times when someone is contageous.
# They infect a random person, according to the specific parameters of the situation (taking into account who and how many people are staying at home.)
# When someone is infected, a 1 gets placed in the newly_infected table for that specific person on the day they're infected.
infect_someone = function(day){
  day_col = str_c("day_", day)
  
  succeptibles = which(newly_infected[[day_col]] == 0)
  person_to_infect = sample(succeptibles,1)
  
  newly_infected[[day_col]][person_to_infect] <<- 1
  }

# remove this later, printing just for debugging
newly_infected
```



```{r}
change_state = function(id, prev_state, day){ #TODO: Fix inputs elsewhere
  new_state = prev_state # The default is to stay at the same state. This always happens for RECOVERED or DEAD
  rand = runif(1) #Question: is it ok to use the same random number for every decision in this function?
  
  if (prev_state == SUCCEPTIBLE) {
    if (newly_infected[[str_c("day_", day)]][id] == 1) {
      if (rand <= probability_asymptomatic) {new_state = INFECTED_ASYMPTOMATIC}
      else {new_state = INFECTED_SYMPTOMATIC_PRE_SYMPTOMS}
    }
  }

  if (prev_state == INFECTED_ASYMPTOMATIC) {
    # wait 4 days before turning infectious
    if (population[[str_c("day_", day - time_until_infectious)]][id] == INFECTED_ASYMPTOMATIC) {
      new_state = INFECTIOUS_ASYMPTOMATIC
      
      # infect others according to parameters
      # TODO - finish this section (infect how many people? on what days?)
      infect_someone(day + 1)
    }
  }

  if (prev_state == INFECTIOUS_ASYMPTOMATIC) {
    # wait 4 days before recovering
    if (population[[str_c("day_", day - asymptomatic_time_from_infectious_to_recovery)]][id] == INFECTED_ASYMPTOMATIC) {
      new_state = RECOVERED
    }
  }

  if (prev_state == INFECTED_SYMPTOMATIC_PRE_SYMPTOMS) {
    # wait 4 days before turning infectious
    if (population[[str_c("day_", day - time_until_infectious)]][id] == INFECTED_SYMPTOMATIC_PRE_SYMPTOMS) {
      new_state = INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS
      
      # infect others according to parameters
      # TODO - finish this section (infect how many people? on what days?)
      infect_someone(day + 1)
    }
  }

  if (prev_state == INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS) {
    # wait 1 day before turning symptomatic. severity of illness is based on demographics
    if (population[[str_c("day_", day - time_infectious_before_symptom_onset)]][id] == INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS) {
      if (rand < 0.2) { # TODO - instead of being a number, rely on a table (to be filled in later)
        new_state = SYMPTOMATIC_NEED_HOSPITAL
      } else { 
        new_state = SYMPTOMATIC_DONT_NEED_HOSPITAL
      }
    }
  }

  if (prev_state == SYMPTOMATIC_NEED_HOSPITAL) {
    # seek care with 5 day delay or don't, depending on demographics
    if (population[[str_c("day_", day - time_until_seeking_care)]][id] == SYMPTOMATIC_NEED_HOSPITAL) {
      if (rand < 0.3) { # TODO - instead of being a number, rely on a table or function (to be filled in later)
        new_state = NEED_HOSPITAL_DONT_SEEK_CARE
      } else {
        new_state = NEED_HOSPITAL_SEEK_CARE
      }
    }
  }

  if (prev_state == SYMPTOMATIC_DONT_NEED_HOSPITAL) {
    # wait 4 days then recover
    if (population[[str_c("day_", day - time_from_symptom_onset_to_recovery)]][id] == SYMPTOMATIC_DONT_NEED_HOSPITAL) {
      new_state = RECOVERED
    }
  }

  if (prev_state == NEED_HOSPITAL_SEEK_CARE) { ## IS THIS REDUNDANT/1 step delayed? PUT INTO SYMPTOMATIC_NEED_HOSPITAL?
    # immediately either get care or don't, depending on bed availability
    if (hospital_beds_available > 0) {
      hospital_beds_available = hospital_beds_available - 1
      new_state = GET_HOSPITAL_CARE
    } else {
      new_state = DONT_GET_NEEDED_CARE
    }
  }

  if (prev_state == NEED_HOSPITAL_DONT_SEEK_CARE) { ## IS THIS REDUNDANT/1 step delayed? PUT INTO SYMPTOMATIC_NEED_HOSPITAL?
    # immediately transition to don't get care
    new_state = DONT_GET_NEEDED_CARE
  }

  if (prev_state == GET_HOSPITAL_CARE) {
    # after 10 days in bed, probabalistically die or recover
    if (population[[str_c("day_", day - time_in_hospital_bed)]][id] == GET_HOSPITAL_CARE) {
      if (rand < 0.5) { # TODO - instead of being a number, rely on a table or function (to be filled in later)
        new_state = DEAD
      } else {
        new_state = RECOVERED
      }
      hospital_beds_available = hospital_beds_available + 1
    }
  }

  if (prev_state == DONT_GET_NEEDED_CARE) {
    # die after 10 days
    if (population[[str_c("day_", day - time_until_death_if_no_care)]][id] == DONT_GET_NEEDED_CARE) {
      new_state = DEAD
    }
  }

  # Take out later, for debugging
  cat("\n\nPerson ID: ", id)
  cat("\nDay: ", day)
  cat("\nPrevious state: ", prev_state)
  cat("\nRandom number: ", rand)
  cat("\nNew state: ", new_state)

  new_state
}

#change_state(2, INFECTED_SYMPTOMATIC_PRE_SYMPTOMS, 3)
```


## Setting up and populating my dataframe

```{r}
# TODO: create the population according to demographic markers, and randomly assign the infected person.
create_initial_population_with_one_infected = function(size){
  one_infected = c(INFECTED_SYMPTOMATIC_PRE_SYMPTOMS)
  others_succeptible = rep(c(SUCCEPTIBLE), size - 1)
  
  c(one_infected, others_succeptible)
}

# OLD CODE: using factors. Don't delete until I've figured it out.
# create_initial_population_with_one_infected = function(size){
#   one_infected = as.factor(c(INFECTED_SYMPTOMATIC_PRE_SYMPTOMS))
#   others_succeptible = rep(as.factor(c(SUCCEPTIBLE)), size - 1)
#   
#   fct_c(one_infected, others_succeptible)
# }

# remove this later, printing just for debugging
create_initial_population_with_one_infected(initial_population_size)
```

This is a table with each row representing one person in the population. The first few columns include demographic and other information about a person, and all of the columns labeled `day_n` represent that person's disease state at time n.
```{r}
# TODO: make a function to generate new day columns based on some initial parameter.
# TODO: decide what to do about states as factors. Currently I just made everything strings because I couldn't keep things straight.
population = tibble(
  person_ids = 1:initial_population_size,
  day_1 = create_initial_population_with_one_infected(initial_population_size)
)

for (day in 2:total_days) {
  prev_day = population[[(str_c("day_", day - 1))]]
  population =
    add_column(
      population,
      !!str_c("day_", day) := flatten_chr(map2(population$person_ids, prev_day, change_state, day))
      )
  }

# remove this later, printing just for debugging
population
```


## Visualization

First, transform the table into a better shape for graphing, by getting the total state counts at each time step.
```{r}
population_to_visualize =
  pivot_longer(
    population,
    cols = starts_with("day_"),
    names_to = "day",
    values_to = "state",
    names_prefix = "day_"
  ) %>% 
  mutate(day = as.numeric(day)) %>% 
  group_by(day, state) %>% 
  summarize(count = n())

## NOTE:
## For transitory states like "infected", the count represents how many people are infected on that day.
## However, for a state like "dead", the count represents how many people total have died up until that point (because once you reach the "dead" state, you stay at that state forever).


# remove this later, printing just for debugging
population_to_visualize
```

Graph the person-count of each state in a different color, with days on the x-axis.
```{r}
ggplot(population_to_visualize, 
       aes(x=day, y=count, color=state)) + 
  geom_line()
```


