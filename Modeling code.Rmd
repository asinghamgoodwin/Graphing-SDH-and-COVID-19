---
title: "Modeling code"
output: github_document
date: 2020-03-30
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Initial Parameters

I am arbitrarily choosing XX,XXX people for my simulation. I am also choosing a timeline similar to what we saw in NYC, with *ADD IN DATES AND INFORMATION*.
```{r}
initial_population_size = 10000 # TODO - choose bigger number later
total_days = 100

# TODO - fill these in with real numbers
day_of_first_distancing_guideline = 10
day_of_stronger_distancing_directive = 15
length_of_distancing_directive = 90
```

These initial parameters come from my best efforts at parsing the literature, specificially *ARTICLE A and ARTICLE B*.
```{r}
## BIG TODO: add citations for these numbers

#probability_symptomatic = 2/3 # Take this out?
probability_asymptomatic = 1/3

# TODO: break this out into it's own code chunk with explanation? Weighted average, solved equations to get 
basic_reproductive_number = 2.4
symptomatic_reproductive_number = basic_reproductive_number*(6/5)
asymptomatic_reproductive_number = basic_reproductive_number*(3/5)

time_until_infectious = 4 # This is figured from the incubation period, and rounded down from 4.6 so I can do steps in full days.

# For the asymptomatic types
asymptomatic_time_from_infectious_to_recovery = 4 # This is figured from the generation time (confusing). Should this be longer??

# For the symptomatic types
time_infectious_before_symptom_onset = 1
time_from_symptom_onset_to_recovery = 4

time_until_seeking_care = 5 # This is the number of days after symptom onset that people seek hospital care if they need it, on average
time_in_hospital_bed = 10
time_until_death_if_no_care = 10

```

These numbers come from *[MODEL](https://columbia.maps.arcgis.com/apps/webappviewer/index.html?id=ade6ba85450c4325a12a5b9c09ba796c) and its corresponding [scientific paper](https://behcolumbia.files.wordpress.com/2020/04/flattening-the-curve-before-it-flattens-us-20200405b.pdf)*.
```{r}
# Below is the sum of ICU beds in the 5 boroughs that could be made available
# in a medium patient surge response situation (i.e. by making other hospital beds available),
# according to the Columbia Severe COVID-19 Risk Mapping tool.

# This number is corroborated by a recent news article (3528 vs. 3500): https://www.businessinsider.com/coronavirus-nyc-more-than-doubled-its-icu-capacity-in-weeks-2020-4
total_nyc_icu_beds_medium_surge_response = 200 + 594 + 276 + 524 + 1934

total_nyc_population = 8398748 # https://www.census.gov/quickfacts/newyorkcitynewyork (2018 estimate)

icu_beds_per_person = total_nyc_icu_beds_medium_surge_response / total_nyc_population

initial_icu_bed_capacity = initial_population_size *  icu_beds_per_person

# This is the part that will be used in my model. It will decrease as people in the model use hospital beds.
icu_beds_available = round(initial_icu_bed_capacity)
```

These come from the *[CENSUS WEBSITE](https://data.census.gov/cedsci/table?q=new%20york%20city%20population&g=1600000US3651000&hidePreview=false&tid=ACSST1Y2018.S0101&vintage=2018&layer=VT_2018_160_00_PY_D1&cid=DP05_0001E)*
```{r, message = FALSE, warning = FALSE}
# TODO - fill in distributions of: age, health status/underlying conditions, "essential" jobs, poverty levels, incarcerated, homeless, detained immigrants, insurance coverage

acs_age_estimates =
  read_csv("./ACSST1Y2018.S0101_data_with_overlays_2020-04-19T143631.csv") %>% 
  select(., matches("S0101_C01_0(0[2-9]|1[0-9])E")) %>% 
  slice(., 2:2) %>% 
  rename_all(~c('00-04','05-09','10-14','15-19','20-24','25-29','30-34','35-39','40-44',
                '45-49','50-54','55-59','60-64', '65-69','70-74','75-79','80-84','85+')) %>% 
  pivot_longer(., everything(), names_to = "age_ranges", values_to = "estimate_numbers") %>% 
  mutate(., estimate_numbers = as.integer(estimate_numbers)) %>% 
  mutate(., decade = substring(age_ranges,1,1)) %>% 
  group_by(., decade) %>% 
  summarise(., num_people = sum(estimate_numbers)) %>% 
  mutate(., percent_of_total = num_people/sum(num_people))
```

These numbers come from *ARTICLE A*, describing the distribution by age of who needs hospital care, and what their mortality rate is.
```{r}
# This table is taken directly from the article
ferguson_et_al_table_1 = tibble(
  age_group_by_decade = 0:8,
  percent_symptomatic_requiring_hospital = c(.001, .003, .012, .032, .049, .102, .166, .243, .273),
  percent_hospital_cases_requiring_critical_care = c(.05, .05, .05, .05, .063, .122, .274, .432, .709),
  infection_fatality_ratio = c(.00002, .00006, .0003, .0008, .0015, .006, .022, .051, .093)
)

# Here, I simplify their parameters to create a table of probabilities by age group to use in my model.
# Rather than splitting between people in the hospital who need critical care or not,
# I count anyone needing hospitalization as needing a bed.

# Rather than using the overall fatality by age group, I assume that the only people who die are people who:
# ... get infected, have symptoms, are sick enough to require hospital care,
# ... and either don't get to the hospital, or do but still die.

# To calculate that last probability (dying in the hospital even if you get care),
# I take the estimate from the article that "50% of those in critical care will die"
# and multiply that by the probability of requiring critical care for those in the hospital.
severity_by_age =
  ferguson_et_al_table_1 %>% 
  mutate(., prob_die_in_icu = 0.5*percent_hospital_cases_requiring_critical_care) %>% 
  rename(., prob_need_any_hospital = percent_symptomatic_requiring_hospital,
         prob_need_icu_bed = percent_hospital_cases_requiring_critical_care) %>% 
  select(., -infection_fatality_ratio)
```

And finally, based on some other research and best guesses:
```{r}
# TODO: flesh out this section

probability_seek_care_insured = 1
probability_seek_care_uninsured = 0.5

# TODO: decide on cutoff poverty level for ignoring a stay-home directive
```


## States

The way I organized my thoughts for this project was to create a state diagram (essentially a flow chart) to lay out all of the different trajectories someone could take through this epidemic. Everyone starts as "succeptible", and from there you have different probabilities of transitioning to other states, dependent on factors like random chance, demographic characteristics, as well as actions taken by others (like infecting you).

*TODO: put in an image of my state diagram*

```{r}
SUCCEPTIBLE = "succeptible"

INFECTED_ASYMPTOMATIC = "infected_asymptomatic"
INFECTIOUS_ASYMPTOMATIC = "infectious_asymptomatic"

INFECTED_SYMPTOMATIC_PRE_SYMPTOMS = "infected_symptomatic_pre_symptoms"
INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS = "infectious_symptomatic_pre_symptoms"

SYMPTOMATIC_NEED_REGULAR_HOSPITAL = "symptomatic_need_regular_hospital"
SYMPTOMATIC_NEED_ICU_BED = "symptomatic_need_icu_bed"
SYMPTOMATIC_DONT_NEED_HOSPITAL = "symptomatic_dont_need_hospital"

GET_REGULAR_HOSPITAL_CARE = "get_regular_hospital_care"
GET_ICU_BED = "get_icu_bed"
DONT_GET_NEEDED_CARE = "dont_get_needed_care"

RECOVERED = "recovered"
DEAD = "dead"
```

I used another state diagram to map out who is staying at home, and who is still out and about.

*TODO: put in an image of my 2nd state diagram*



## Change states on each timestep

Helper functions: 
```{r}
# Set up an empty table with columns for each day in the simulation.
# When someone is randomly selected to be infected, I put a 1 in the spot corresponding to that person (row) on that day (column).
# This is referenced by the change_state function, to transition people from SUCCEPTIBLE to INFECTED.
newly_infected = tibble(
  person_ids = 1:initial_population_size,
)

for (i in 1:total_days) {
  newly_infected =
    add_column(
      newly_infected,
      !!str_c("day_", i) := 0
      )
}

# This function gets called a variable number of times when someone is contageous.
# They infect a random person, according to the specific parameters of the situation (taking into account who and how many people are staying at home.)
# When someone is infected, a 1 gets placed in the newly_infected table for that specific person on the day they're infected.
infect_someone = function(day){
  day_col = str_c("day_", day)
  
  succeptibles = which(newly_infected[[day_col]] == 0)
  person_to_infect = sample(succeptibles,1)
  
  # newly_infected[[day_col]][person_to_infect] <<- 1
  }

# remove this later, printing just for debugging
newly_infected
```



```{r}
change_state = function(id, prev_state, day, population){ #TODO: Fix inputs elsewhere
  new_state = prev_state # The default is to stay at the same state. This always happens for RECOVERED or DEAD
  rand = .9 ## JUST FOR DEBUGGING
  #rand = runif(1) #Question: is it ok to use the same random number for every decision in this function?
  
  if (prev_state == SUCCEPTIBLE) {
    if (newly_infected[[str_c("day_", day)]][id] == 1) {
      if (rand <= probability_asymptomatic) {new_state = INFECTED_ASYMPTOMATIC}
      else {new_state = INFECTED_SYMPTOMATIC_PRE_SYMPTOMS}
    }
  }

  if (prev_state == INFECTED_ASYMPTOMATIC) {
    # wait 4 days before turning infectious
    earlier_state_to_check = population[[str_c("day_", day - time_until_infectious)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == INFECTED_ASYMPTOMATIC) {
      new_state = INFECTIOUS_ASYMPTOMATIC
      
      # infect others according to parameters
      # TODO - finish this section (infect how many people? on what days?)
      infect_someone(day + 1)
    }
  }

  if (prev_state == INFECTIOUS_ASYMPTOMATIC) {
    # wait 4 days before recovering
    earlier_state_to_check = population[[str_c("day_", day - asymptomatic_time_from_infectious_to_recovery)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == INFECTIOUS_ASYMPTOMATIC) {
      new_state = RECOVERED
    }
  }

  if (prev_state == INFECTED_SYMPTOMATIC_PRE_SYMPTOMS) {
    # wait 4 days before turning infectious
    earlier_state_to_check = population[[str_c("day_", day - time_until_infectious)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == INFECTED_SYMPTOMATIC_PRE_SYMPTOMS) {
      new_state = INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS
      
      # infect others according to parameters
      # TODO - finish this section (infect how many people? on what days?)
      infect_someone(day + 1)
    }
  }

  if (prev_state == INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS) {
    # wait 1 day before turning symptomatic. severity of illness is based on demographics
    earlier_state_to_check = population[[str_c("day_", day - time_infectious_before_symptom_onset)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS) {
      if (rand < 0.2) { # TODO - instead of being a number, rely on a table: severity_by_age$prob_need_hospital
        if (rand < 0.1) { # for this random number, maybe do .2*.1? severity_by_age$prob_need_icu
          new_state = SYMPTOMATIC_NEED_ICU_BED
        } else {
          new_state = SYMPTOMATIC_NEED_REGULAR_HOSPITAL
        }
      } else { 
        new_state = SYMPTOMATIC_DONT_NEED_HOSPITAL
      }
    }
  }

  if (prev_state == SYMPTOMATIC_NEED_ICU_BED) {
    # seek care with 5 day delay or don't, depending on demographics
    earlier_state_to_check = population[[str_c("day_", day - time_until_seeking_care)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == SYMPTOMATIC_NEED_ICU_BED) {
      if (rand < 0.3) { # If they don't seek care: # TODO - instead of being a number, rely on a table or function (to be filled in later)
        new_state = DONT_GET_NEEDED_CARE
      } else { # If they do seek care: either get care or don't, depending on bed availability
        if (icu_beds_available > 0) {
          icu_beds_available = icu_beds_available - 1
          new_state = GET_ICU_BED
        } else {
          new_state = DONT_GET_NEEDED_CARE
        }
      }
    }
  }

  if (prev_state == SYMPTOMATIC_NEED_REGULAR_HOSPITAL) {
    # seek care with 5 day delay or don't, depending on demographics
    earlier_state_to_check = population[[str_c("day_", day - time_until_seeking_care)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == SYMPTOMATIC_NEED_REGULAR_HOSPITAL) {
      if (rand < 0.3) { # If they don't seek care: # TODO - instead of being a number, rely on a table or function (to be filled in later)
        new_state = DONT_GET_NEEDED_CARE
      } else {
        new_state = GET_REGULAR_HOSPITAL_CARE
      }
    }
  }

  if (prev_state == SYMPTOMATIC_DONT_NEED_HOSPITAL) {
    # wait 4 days then recover
    earlier_state_to_check = population[[str_c("day_", day - time_from_symptom_onset_to_recovery)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == SYMPTOMATIC_DONT_NEED_HOSPITAL) {
      new_state = RECOVERED
    }
  }

  if (prev_state == GET_ICU_BED) {
    # after 10 days in bed, probabalistically die or recover
    earlier_state_to_check = population[[str_c("day_", day - time_in_hospital_bed)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == GET_ICU_BED) {
      if (rand < 0.5) { # TODO - instead of being a number, rely on a table: severity_by_age$prob_die_in_ICU
        new_state = DEAD
      } else {
        new_state = RECOVERED
      }
      icu_beds_available = icu_beds_available + 1
    }
  }
  
  if (prev_state == GET_REGULAR_HOSPITAL_CARE) {
    # after 10 days in bed, recover
    earlier_state_to_check = population[[str_c("day_", day - time_in_hospital_bed)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == GET_REGULAR_HOSPITAL_CARE) {
      new_state = RECOVERED
    }
  }

  if (prev_state == DONT_GET_NEEDED_CARE) {
    # die after 10 days
    earlier_state_to_check = population[[str_c("day_", day - time_until_death_if_no_care)]][id]
    if (!is.null(earlier_state_to_check) && earlier_state_to_check == DONT_GET_NEEDED_CARE) {
      new_state = DEAD
    }
  }

  # Take out later, for debugging
  # cat("\n\nPerson ID: ", id)
  # cat("\nDay: ", day)
  # cat("\nPrevious state: ", prev_state)
  # cat("\nRandom number: ", rand)
  # cat("\nNew state: ", new_state)

  new_state
}
```


## Setting up and populating my dataframe

```{r}
# TODO: create the population according to demographic markers, and randomly assign the infected person.
create_initial_population_with_one_infected = function(size){
  one_infected = c(INFECTED_SYMPTOMATIC_PRE_SYMPTOMS)
  others_succeptible = rep(c(SUCCEPTIBLE), size - 1)
  
  c(one_infected, others_succeptible)
}

one_of_each_state = function(size){
  c(SUCCEPTIBLE,
    INFECTED_ASYMPTOMATIC,
    INFECTIOUS_ASYMPTOMATIC,
    INFECTED_SYMPTOMATIC_PRE_SYMPTOMS,
    INFECTIOUS_SYMPTOMATIC_PRE_SYMPTOMS,
    SYMPTOMATIC_NEED_REGULAR_HOSPITAL,
    SYMPTOMATIC_NEED_ICU_BED,
    SYMPTOMATIC_DONT_NEED_HOSPITAL,
    GET_REGULAR_HOSPITAL_CARE,
    GET_ICU_BED,
    DONT_GET_NEEDED_CARE,
    RECOVERED,
    DEAD)
}

# OLD CODE: using factors. Don't delete until I've figured it out.
# create_initial_population_with_one_infected = function(size){
#   one_infected = as.factor(c(INFECTED_SYMPTOMATIC_PRE_SYMPTOMS))
#   others_succeptible = rep(as.factor(c(SUCCEPTIBLE)), size - 1)
#   
#   fct_c(one_infected, others_succeptible)
# }

# remove this later, printing just for debugging
#create_initial_population_with_one_infected(initial_population_size)
```

This is a table with each row representing one person in the population. The first few columns include demographic and other information about a person, and all of the columns labeled `day_n` represent that person's disease state at time n.
```{r}
# TODO: decide what to do about states as factors. Currently I just made everything strings because I couldn't keep things straight.
run_simulation = function(initial_population_size, initial_population_function, total_days) {
  population = tibble(
    person_ids = 1:initial_population_size,
    day_1 = initial_population_function(initial_population_size)
  )
  
  for (day in 2:total_days) {
    prev_day = population[[(str_c("day_", day - 1))]]
    population =
      add_column(
        population,
        !!str_c("day_", day) := flatten_chr(map2(population$person_ids, prev_day, change_state, day, population))
      )
  }
  
  population
}

#population = run_simulation(initial_population_size, create_initial_population_with_one_infected, total_days)
population = run_simulation(13, one_of_each_state, 30)
population

```


## Visualization

First, transform the table into a better shape for graphing, by getting the total state counts at each time step.
```{r}
# TODO:
# 1. combine into infected: all but succeptible, recocered, dead
# 2. combine into need hospital care: get_hospital_care, dont_get_needed_care
population_to_visualize =
  pivot_longer(
    population,
    cols = starts_with("day_"),
    names_to = "day",
    values_to = "state",
    names_prefix = "day_"
  ) %>% 
  mutate(day = as.numeric(day)) %>% 
  group_by(day, state) %>%
  summarize(count = n())

## NOTE:
## For transitory states like "infected", the count represents how many people are infected on that day.
## However, for a state like "dead", the count represents how many people total have died up until that point (because once you reach the "dead" state, you stay at that state forever).


# remove this later, printing just for debugging
population_to_visualize
```

Graph the person-count of each state in a different color, with days on the x-axis.
```{r}
# TODO:
# 1. graph straight line for hospital bed capacity
# 2. add counts and rates for: total dead, total cases, number never sick, total denied care b/c over capacity (not the same as didn't seek care)
ggplot(population_to_visualize, 
       aes(x = day, y = count, color = state)) + 
  geom_line()
```


